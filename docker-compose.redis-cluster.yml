# Docker Compose: Redis Cluster Mode
# Tests Redis in cluster configuration (3 masters + 3 replicas)

services:
  # ==========================================
  # REDIS CLUSTER NODES
  # ==========================================
  redis-node-1:
    image: redis:7-alpine
    container_name: redis-node-1
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 7001
    ports:
      - "7001:7001"
    networks:
      - sys-net

  redis-node-2:
    image: redis:7-alpine
    container_name: redis-node-2
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 7002
    ports:
      - "7002:7002"
    networks:
      - sys-net

  redis-node-3:
    image: redis:7-alpine
    container_name: redis-node-3
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 7003
    ports:
      - "7003:7003"
    networks:
      - sys-net

  redis-node-4:
    image: redis:7-alpine
    container_name: redis-node-4
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 7004
    ports:
      - "7004:7004"
    networks:
      - sys-net

  redis-node-5:
    image: redis:7-alpine
    container_name: redis-node-5
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 7005
    ports:
      - "7005:7005"
    networks:
      - sys-net

  redis-node-6:
    image: redis:7-alpine
    container_name: redis-node-6
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 7006
    ports:
      - "7006:7006"
    networks:
      - sys-net

  # Cluster initialization
  redis-cluster-init:
    image: redis:7-alpine
    container_name: redis-cluster-init
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6
    command: >
      sh -c "sleep 5 && 
             redis-cli --cluster create 
             redis-node-1:7001 
             redis-node-2:7002 
             redis-node-3:7003 
             redis-node-4:7004 
             redis-node-5:7005 
             redis-node-6:7006 
             --cluster-replicas 1 --cluster-yes"
    networks:
      - sys-net

  # ==========================================
  # MYSQL (Single Instance)
  # ==========================================
  mysql:
    image: mysql:8.0
    container_name: sys-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-sys_platform}
      MYSQL_USER: ${MYSQL_USER:-user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - sys-net

  # ==========================================
  # KAFKA + ZOOKEEPER
  # ==========================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: sys-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - sys-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: sys-kafka
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - sys-net

  # ==========================================
  # BACKEND (Connects to Redis Cluster)
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sys-backend
    restart: on-failure
    depends_on:
      - mysql
      - redis-cluster-init
      - kafka
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/sys_platform
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER:-user}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD:-password}
      # Redis Cluster configuration
      SPRING_REDIS_CLUSTER_NODES: redis-node-1:7001,redis-node-2:7002,redis-node-3:7003,redis-node-4:7004,redis-node-5:7005,redis-node-6:7006
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      APP_CORS_ALLOWED_ORIGINS: "*"
      # Set Redis mode to cluster
      APP_REDIS_MODE: cluster
    networks:
      - sys-net

networks:
  sys-net:
    driver: bridge

volumes:
  mysql_data:
  kafka_data:
